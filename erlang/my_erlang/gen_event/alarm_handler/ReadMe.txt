


The alarm handler process is a gen_event event manager process that receives alarms in the system. 
系统启动时，会安装一个简单的 handler, 在没有被替换之前，消息很简单
这个简单的handler，可以被用户自定义的替换掉
替换之后，就是用户定义的handler在起作用了

This process is not intended to be a complete alarm handler. It defines a place to which alarms can be sent. One simple event handler is installed in the alarm handler at startup, but users are encouraged to write and install their own handlers.


%% 这是系统自定义的报警方式， 没有经过swap替换成自定义之前
%% 这里限制没那么严格  {AlarmId, AlarmDescr} 只是一种形式，完全可以是一个原子
The alarm handler is part of the SASL application.
When writing new event handlers for the alarm handler, the following events must be handled:
{set_alarm, {AlarmId, AlarmDescr}}
This event is generated by alarm_handler:set_alarm({AlarmId, AlarmDecsr}).  

Eshell V13.0.4  (abort with ^G)
1> alarm_handler:set_alarm({100, tooHot}).
ok
2> =INFO REPORT==== 17-Oct-2022::05:18:01.086720 ===
    alarm_handler: {set,{100,tooHot}}

这个是handler自带的，一旦自定义handler替换掉之后，这个函数就失效了
2> alarm_handler:get_alarms().
[{100,tooHot}]

%% 用自定义替换掉自带的简单handler 之后就开始 自定义的handler起作用，原来的就被替换掉了

3> gen_event:swap_handler(alarm_handler, {alarm_handler, swap}, {my_alarm_handler, xyz}).
*** my_alarm_handler init:{xyz,{alarm_handler,[{100,tooHot}]}}
ok

%% 再执行，聚会报错
4> alarm_handler:get_alarms().
{error,bad_module}

%% This event is generated by alarm_handler:set_alarm({AlarmId, AlarmDecsr}). 
%% 通过 set_alarm 来触发告警 
%% my_alarm_handler 会通过 handle_event 打印响应的消息

5> alarm_handler:set_alarm({100,tooHot}).
=ERROR REPORT==== 17-Oct-2022::05:40:04.774617 ===
*** Tell the Engineer to turn on the fan

ok


%% 清除消息
{clear_alarm, AlarmId} This event is generated by alarm_handler:clear_alarm(AlarmId).

6> alarm_handler:clear_alarm(100).
=ERROR REPORT==== 17-Oct-2022::05:42:15.879707 ===
*** Danger over. Turn off the fan

ok
%% 配置文件中设置了 输出到二进制文件 rb 来解析
7> rb:start([{max, 20}]).
rb: reading report...done.
rb: reading report...done.
rb: reading report...done.
rb: reading report...done.
=PROGRESS REPORT==== 17-Oct-2022::05:43:49.142865 ===
    supervisor: {local,sasl_sup}
    started: [{pid,<0.99.0>},
              {id,rb_server},
              {mfargs,{rb,start_link,[[{max,20}]]}},
              {restart_type,temporary},
              {significant,false},
              {shutdown,brutal_kill},
              {child_type,worker}]

{ok,<0.99.0>}

8> rb:list().
  No                Type   Process       Date     Time
  ==                ====   =======       ====     ====
  20         info_report  <0.79.0> 2022-10-17 04:44:28
  19               error  <0.79.0> 2022-10-17 04:45:38
  18               error  <0.79.0> 2022-10-17 04:46:03
  17            progress  <0.79.0> 2022-10-17 04:46:10
  16            progress  <0.79.0> 2022-10-17 05:16:16
  15            progress  <0.79.0> 2022-10-17 05:16:16
  14            progress  <0.79.0> 2022-10-17 05:16:16
  13            progress  <0.65.0> 2022-10-17 05:16:16
  12            progress  <0.79.0> 2022-10-17 05:17:05
  11            progress  <0.79.0> 2022-10-17 05:17:05
  10            progress  <0.79.0> 2022-10-17 05:17:05
   9            progress  <0.65.0> 2022-10-17 05:17:05
   8         info_report  <0.79.0> 2022-10-17 05:18:01
   7            progress  <0.79.0> 2022-10-17 05:35:22
   6            progress  <0.79.0> 2022-10-17 05:35:22
   5            progress  <0.79.0> 2022-10-17 05:35:23
   4            progress  <0.65.0> 2022-10-17 05:35:23
   3         info_report  <0.79.0> 2022-10-17 05:35:33
   2               error  <0.79.0> 2022-10-17 05:40:04
   1               error  <0.79.0> 2022-10-17 05:42:15
ok
9> rb:show(1).    %%  第一个消息也就是最后一个消息，是清除告警 error_logger:error_msg("*** Danger over. Turn off the fan~n"),

ERROR REPORT  <0.86.0>                                      2022-10-17 05:42:15
===============================================================================

*** Danger over. Turn off the fan
ok
10> rb:show(2). %% 这个消息生成一个告警 error_logger:error_msg("*** Tell the Engineer to turn on the fan~n"),

ERROR REPORT  <0.86.0>                                      2022-10-17 05:40:04
===============================================================================

*** Tell the Engineer to turn on the fan
ok













%%%%%%%%%%%%%%%%%%%%%%%%% 用原子替换 {}
2> alarm_handler:set_alarm(tooHot).
ok
3> =INFO REPORT==== 17-Oct-2022::04:44:28.429728 ===
    alarm_handler: {set,tooHot}

3> alarm_handler:get_alarms().
[tooHot]
4> gen_event:swap_handler(alarm_handler, {alarm_handler, swap}, {my_alarm_handler, xyz}).
*** my_alarm_handler init:{xyz,{alarm_handler,[tooHot]}}
ok
5> alarm_handler:get_alarms().
{error,bad_module}
6> alarm_handler:set_alarm(tooHot).
ok
7>
7> =ERROR REPORT==== 17-Oct-2022::04:45:38.496498 ===
*** Tell the Engineer to turn on the fan


7>  alarm_handler:clear_alarm(tooHot).
ok
8> =ERROR REPORT==== 17-Oct-2022::04:46:03.635098 ===
*** Danger over. Turn off the fan

rb:start([{max, 20}]).
rb: reading report...done.
rb: reading report...done.
=PROGRESS REPORT==== 17-Oct-2022::04:46:10.584195 ===
    supervisor: {local,sasl_sup}
    started: [{pid,<0.146.0>},
              {id,rb_server},
              {mfargs,{rb,start_link,[[{max,20}]]}},
              {restart_type,temporary},
              {significant,false},
              {shutdown,brutal_kill},
              {child_type,worker}]

{ok,<0.146.0>}

