#--------------------------第一个shell窗口----------------------
#将上面的程序保存成tun.c，然后编译

ericksun@debian-4:~/programming/linux/tun-tap$ make
gcc -Wall -g  tun.c -o tun

#启动tun程序，程序会创建一个新的tun设备，
#程序会阻塞在这里，等着数据包过来

ericksun@debian-4:~/programming/linux/tun-tap$ sudo ./tun
Open tun/tap device: tun0 for reading...


#--------------------------第二个shell窗口----------------------
#启动抓包程序，抓经过tun0的包
ericksun@debian-4:~/ccie/vxlan_ovs$ sudo tcpdump -Xpnni tun0
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on tun0, link-type RAW (Raw IP), capture size 262144 bytes
03:58:58.969910 IP 192.168.1.100 > 192.168.1.101: ICMP echo request, id 7223, seq 1, length 64
        0x0000:  4500 0054 6697 4000 4001 4ff8 c0a8 0164  E..Tf.@.@.O....d
        0x0010:  c0a8 0165 0800 e3f6 1c37 0001 02d5 7e5c  ...e.....7....~\
        0x0020:  0000 0000 a9cc 0e00 0000 0000 1011 1213  ................
        0x0030:  1415 1617 1819 1a1b 1c1d 1e1f 2021 2223  .............!"#
        0x0040:  2425 2627 2829 2a2b 2c2d 2e2f 3031 3233  $%&'()*+,-./0123
        0x0050:  3435 3637                                4567
03:58:59.976384 IP 192.168.1.100 > 192.168.1.101: ICMP echo request, id 7223, seq 2, length 64
        0x0000:  4500 0054 6773 4000 4001 4f1c c0a8 0164  E..Tgs@.@.O....d
        0x0010:  c0a8 0165 0800 9edc 1c37 0002 03d5 7e5c  ...e.....7....~\
        0x0020:  0000 0000 ede5 0e00 0000 0000 1011 1213  ................
        0x0030:  1415 1617 1819 1a1b 1c1d 1e1f 2021 2223  .............!"#
        0x0040:  2425 2627 2829 2a2b 2c2d 2e2f 3031 3233  $%&'()*+,-./0123
        0x0050:  3435 3637                                4567
03:59:00.999661 IP 192.168.1.100 > 192.168.1.101: ICMP echo request, id 7223, seq 3, length 64
        0x0000:  4500 0054 67af 4000 4001 4ee0 c0a8 0164  E..Tg.@.@.N....d
        0x0010:  c0a8 0165 0800 ae80 1c37 0003 04d5 7e5c  ...e.....7....~\
        0x0020:  0000 0000 dc40 0f00 0000 0000 1011 1213  .....@..........
        0x0030:  1415 1617 1819 1a1b 1c1d 1e1f 2021 2223  .............!"#
        0x0040:  2425 2627 2829 2a2b 2c2d 2e2f 3031 3233  $%&'()*+,-./0123
        0x0050:  3435 3637                                4567
03:59:02.023922 IP 192.168.1.100 > 192.168.1.101: ICMP echo request, id 7223, seq 4, length 64
        0x0000:  4500 0054 67b5 4000 4001 4eda c0a8 0164  E..Tg.@.@.N....d
        0x0010:  c0a8 0165 0800 3663 1c37 0004 06d5 7e5c  ...e..6c.7....~\
        0x0020:  0000 0000 615d 0000 0000 0000 1011 1213  ....a]..........
        0x0030:  1415 1617 1819 1a1b 1c1d 1e1f 2021 2223  .............!"#
        0x0040:  2425 2627 2829 2a2b 2c2d 2e2f 3031 3233  $%&'()*+,-./0123
        0x0050:  3435 3637                                4567


#--------------------------第三个shell窗口----------------------
#./tun启动之后，通过ip link命令就会发现系统多了一个tun设备，
#在我的测试环境中，多出来的设备名称叫tun0，在你的环境中可能叫tun1
#新的设备没有ip，我们先给tun0配上IP地址

ericksun@debian-4:~/programming/linux/tun-tap$ sudo ip address a  192.168.1.100/24 dev tun0


#默认情况下，tun0没有起来，用下面的命令将tun0启动起来
ericksun@debian-4:~/programming/linux/tun-tap$ sudo ip link set tun0 up

#尝试ping一下192.168.1.0/24网段的IP，
#根据默认路由，该数据包会走tun0设备，
ericksun@debian-4:~/programming/linux/tun-tap$ ip r
default via 192.168.247.2 dev ens33
172.16.0.0/24 dev br1 proto kernel scope link src 172.16.0.4
192.168.1.0/24 dev tun0 proto kernel scope link src 192.168.1.100
192.168.247.0/24 dev ens33 proto kernel scope link src 192.168.247.137

#由于我们的程序中收到数据包后，啥都没干，相当于把数据包丢弃了，
#所以这里的ping根本收不到返回包，
#但在前两个窗口中可以看到这里发出去的四个icmp echo请求包，
#说明数据包正确的发送到了应用程序里面，只是应用程序没有处理该包

ericksun@debian-4:~/ccie/vxlan_ovs$ sudo tcpdump -Xpnni tun0
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on tun0, link-type RAW (Raw IP), capture size 262144 bytes
03:58:58.969910 IP 192.168.1.100 > 192.168.1.101: ICMP echo request, id 7223, seq 1, length 64
        0x0000:  4500 0054 6697 4000 4001 4ff8 c0a8 0164  E..Tf.@.@.O....d
        0x0010:  c0a8 0165 0800 e3f6 1c37 0001 02d5 7e5c  ...e.....7....~\
        0x0020:  0000 0000 a9cc 0e00 0000 0000 1011 1213  ................
        0x0030:  1415 1617 1819 1a1b 1c1d 1e1f 2021 2223  .............!"#
        0x0040:  2425 2627 2829 2a2b 2c2d 2e2f 3031 3233  $%&'()*+,-./0123
        0x0050:  3435 3637                                4567
03:58:59.976384 IP 192.168.1.100 > 192.168.1.101: ICMP echo request, id 7223, seq 2, length 64
        0x0000:  4500 0054 6773 4000 4001 4f1c c0a8 0164  E..Tgs@.@.O....d
        0x0010:  c0a8 0165 0800 9edc 1c37 0002 03d5 7e5c  ...e.....7....~\
        0x0020:  0000 0000 ede5 0e00 0000 0000 1011 1213  ................
        0x0030:  1415 1617 1819 1a1b 1c1d 1e1f 2021 2223  .............!"#
        0x0040:  2425 2627 2829 2a2b 2c2d 2e2f 3031 3233  $%&'()*+,-./0123
        0x0050:  3435 3637                                4567
03:59:00.999661 IP 192.168.1.100 > 192.168.1.101: ICMP echo request, id 7223, seq 3, length 64
        0x0000:  4500 0054 67af 4000 4001 4ee0 c0a8 0164  E..Tg.@.@.N....d
        0x0010:  c0a8 0165 0800 ae80 1c37 0003 04d5 7e5c  ...e.....7....~\
        0x0020:  0000 0000 dc40 0f00 0000 0000 1011 1213  .....@..........
        0x0030:  1415 1617 1819 1a1b 1c1d 1e1f 2021 2223  .............!"#
        0x0040:  2425 2627 2829 2a2b 2c2d 2e2f 3031 3233  $%&'()*+,-./0123
        0x0050:  3435 3637                                4567
03:59:02.023922 IP 192.168.1.100 > 192.168.1.101: ICMP echo request, id 7223, seq 4, length 64
        0x0000:  4500 0054 67b5 4000 4001 4eda c0a8 0164  E..Tg.@.@.N....d
        0x0010:  c0a8 0165 0800 3663 1c37 0004 06d5 7e5c  ...e..6c.7....~\
        0x0020:  0000 0000 615d 0000 0000 0000 1011 1213  ....a]..........
        0x0030:  1415 1617 1819 1a1b 1c1d 1e1f 2021 2223  .............!"#
        0x0040:  2425 2627 2829 2a2b 2c2d 2e2f 3031 3233  $%&'()*+,-./0123
        0x0050:  3435 3637                                4567

