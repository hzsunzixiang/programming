
title  基于国密的镜像的完整性校验方案-首次导入镜像
participant 用户        as A
participant CVM         as B
participant CBS         as C


par: 外部导入镜像
    A->+B: 外部导入镜像
    note right of A
    1. 镜像导入之前为QCOW2格式
    2. 导入成功之后放入CBS系统中
	3. 镜像在CBS系统中以RAW格式存在
    end note
	B->+C: 请求CBS导入RAW格式镜像
    note right of B
    1. CBS以每块5M的大小放入COS中
    2. 每块数据都有一个MD5值
	3. 每个RAW格式镜像都对应一个MD5值的列表
	end note
	C->-B: RAW镜像导入CBS成功
    B-->-A: 外部导入镜像成功

end


par: 获取镜像的MD5值列表
    B->+C: 向CBS请求MD5值的列表
    note right of B
    1. 这个操作是异步的
    2. CBS会返回一个taskId供查询
	3. CBS把所有的MD5值的列表放到某个地方
	4. CVM后续会从同样的这个地方获取
    end note
	C-->-B: CBS返回TaskId
	loop: 循环直到成功
      	B->+C: 以TaskId请求CBS，是否导出MD5列表成功，
        note right of B
        1. 导出的MD5列表放到某个公共的CVM也能够访问的存储上
        2. 一旦CBS指明返回成功，就去相应的存储上导出MD5列表
	    end note
	    C-->-B: CBS指示MD5列表导出成功， 
    end

end

par: 首次用国密计算镜像的HMAC-SM3值
    B->+B: 国密计算hash
    note left of B
    1. CVM从如上协商的存储位置获取MD5值列表
	2. 同时会有一个预制的密钥：secret_key
    3. 使用MD5值列表和secret_key计算HMAC-SM3，并存入数据库
	   hmac.new(key, msg, hashlib.sm3).hexdigest()  
    end note
	B-->-B:  国密计算hash结束
end


